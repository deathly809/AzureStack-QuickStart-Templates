{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "apiProfile": "2017-03-09-profile",
    "parameters": {
        "clusterName": {
            "type": "string",
            "metadata": {
                "description": "Name of the hadoop cluster.  This must be a unique value."
            }
        },
        "adminUsername": {
            "type": "string",
            "defaultValue": "localadmin",
            "metadata": {
                "description": "Username for the deployed virtual machines."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Password for the deployed virtual machines."
            }
        },
        "storageAccountType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Storage account type."
            }
        },
        "masterNodeVMSize": {
            "type": "string",
            "defaultValue": "Standard_A4",
            "allowedValues": [
                "Standard_A4",
                "Standard_A5",
                "Standard_A6",
                "Standard_A7"
            ],
            "metadata": {
                "description": "The size of the virtual machine master nodes."
            }
        },
        "workerNodeVMSize": {
            "type": "string",
            "defaultValue": "Standard_DS3_v2",
            "allowedValues": [
                "Standard_DS3_v2",
                "Standard_DS4_v2"
            ],
            "metadata": {
                "description": "The size of the Virtual Machine worker nodes."
            }
        },
        "numberWorkerNodes": {
            "type": "int",
            "defaultValue": 4,
            "minValue": 1,
            "maxValue": 32,
            "metadata": {
                "description": "The number of worker nodes in the cluster."
            }
        },
        "dataDiskSize": {
            "type": "int",
            "defaultValue": 512,
            "allowedValues": [
                128,
                256,
                512,
                768,
                1024
            ],
            "metadata": {
                "description": "Size of the attached data disks in GB."
            }
        }
    },
    "variables": {
        "defaultName": "[parameters('clusterName')]",
        "location": "[resourceGroup().location]",
        "dnsNameForPublicIP": "[parameters('clusterName')]",
        "publicIPAddressName": "[concat(variables('defaultName'),'pubip')]",
        "publicIPAddressType": "Dynamic",
        "addressPrefix": "10.0.0.0/16",
        "storageAccountName": "[tolower(concat(variables('defaultName'),'sa'))]",
        "networkSecurityGroupName": "[tolower(concat(variables('defaultName'),'nsg'))]",
        "subnetName": "[concat(variables('defaultName'),'sub')]",
        "virtualNetworkName": "[concat(variables('defaultName'),'vnet')]",
        "loadBalancerName": "[concat(variables('defaultName'),'lb')]",
        "jumpBoxIpPrefix": "10.0.0.",
        "masterIpPrefix": "10.0.1.",
        "workerIpPrefix": "10.0.2.",
        "baseURI": "https://raw.githubusercontent.com/deathly809/AzureStack-QuickStart-Templates/hadoop/hadoop"
    },
    "resources": [
        {
            "comments": "Storage account which holds all containers and logs.",
            "type": "Microsoft.Storage/storageAccounts",
            "name": "[toLower(variables('storageAccountName'))]",
            "apiVersion": "2015-06-15",
            "location": "[variables('location')]",
            "properties": {
                "accountType": "[parameters('storageAccountType')]"
            }
        },
        {
            "comments": "Virtual network in which the nodes will reside.",
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[variables('virtualNetworkName')]",
            "location": "[variables('location')]",
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('addressPrefix')]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('subnetName')]",
                        "properties": {
                            "addressPrefix": "[variables('addressPrefix')]"
                        }
                    }
                ]
            }
        },
        {
            "comments": "The public IP addresses for NAT.",
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('publicIPAddressName')]",
            "location": "[variables('location')]",
            "properties": {
                "publicIPAllocationMethod": "[variables('publicIPAddressType')]",
                "dnsSettings": {
                    "domainNameLabel": "[tolower(variables('dnsNameForPublicIP'))]"
                }
            }
        },
        {
            "comments": "Network security group for the network.",
            "apiVersion": "2015-06-15",
            "type": "Microsoft.Network/networkSecurityGroups",
            "name": "[variables('networkSecurityGroupName')]",
            "location": "[variables('location')]",
            "properties": {
                "securityRules": []
            }
        },
        {
            "name": "[variables('loadBalancerName')]",
            "type": "Microsoft.Network/loadBalancers",
            "apiVersion": "2015-06-15",
            "location": "[variables('location')]",
            "properties": {
                "frontendIPConfigurations": [
                    {
                        "name": "frontEndLoadBalancer",
                        "properties": {
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressName'))]"
                            }
                        }
                    }
                ],
                "loadBalancerBackendAddressPools": [
                    {
                        "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/backendAddressPools/', 'backendAddressPool')]"
                    }
                ],
                "inboundNatRules": [
                    {
                        "name": "ssh",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', 'frontEndLoadBalancer')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 22,
                            "backendPort": 22,
                            "enableFloatingIP": false
                        }
                    },
                    {
                        "name": "JumpNode",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', 'frontEndLoadBalancer')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 1000,
                            "backendPort": 1000,
                            "enableFloatingIP": false
                        }
                    },
                    {
                        "name": "NameNode",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', 'frontEndLoadBalancer')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 2000,
                            "backendPort": 2000,
                            "enableFloatingIP": false
                        }
                    },
                    {
                        "name": "ResourceManager",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', 'frontEndLoadBalancer')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 3000,
                            "backendPort": 3000,
                            "enableFloatingIP": false
                        }
                    },
                    {
                        "name": "WebAppProxy",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', 'frontEndLoadBalancer')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 4000,
                            "backendPort": 4000,
                            "enableFloatingIP": false
                        }
                    },
                    {
                        "name": "MapReduceJobHistory",
                        "properties": {
                            "frontendIPConfiguration": {
                                "id": "[concat(resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', 'frontEndLoadBalancer')]"
                            },
                            "protocol": "tcp",
                            "frontendPort": 5000,
                            "backendPort": 5000,
                            "enableFloatingIP": false
                        }
                    }
                ]
            },
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressName'))]"
            ]
        },
        {
            "apiVersion": "2017-05-10",
            "name": "masterNodeTemplate",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[variables('storageAccountName')]",
                "[variables('loadBalancerName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseURI'),'/master_node.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "clusterName": {
                        "value": "[parameters('clusterName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "vmSize": {
                        "value": "[parameters('masterNodeVMSize')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "networkSecurityGroupName": {
                        "value": "[variables('networkSecurityGroupName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "subnetName": {
                        "value": "[variables('subnetName')]"
                    },
                    "loadBalancerName": {
                        "value": "[variables('loadBalancerName')]"
                    },
                    "ipPrefix": {
                        "value": "[variables('masterIpPrefix')]"
                    },
                    "baseURI": {
                        "value": "[variables('baseURI')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "workerNodeTemplate",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "[variables('storageAccountName')]",
                "[variables('loadBalancerName')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseURI'),'/worker_node.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "clusterName": {
                        "value": "[parameters('clusterName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "vmSize": {
                        "value": "[parameters('workerNodeVMSize')]"
                    },
                    "numberWorkers": {
                        "value": "[parameters('numberWorkerNodes')]"
                    },
                    "dataDiskSize": {
                        "value": "[parameters('dataDiskSize')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "subnetName": {
                        "value": "[variables('subnetName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "ipPrefix": {
                        "value": "[variables('workerIpPrefix')]"
                    },
                    "networkSecurityGroupName": {
                        "value": "[variables('networkSecurityGroupName')]"
                    },
                    "baseURI": {
                        "value": "[variables('baseURI')]"
                    }
                }
            }
        },
        {
            "apiVersion": "2017-05-10",
            "name": "jumpBoxTemplate",
            "type": "Microsoft.Resources/deployments",
            "dependsOn": [
                "masterNodeTemplate",
                "workerNodeTemplate"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('baseURI'),'/jumpbox_node.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "clusterName": {
                        "value": "[parameters('clusterName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "vmSize": {
                        "value": "[parameters('masterNodeVMSize')]"
                    },
                    "numberWorkers": {
                        "value": "[parameters('numberWorkerNodes')]"
                    },
                    "storageAccountName": {
                        "value": "[variables('storageAccountName')]"
                    },
                    "subnetName": {
                        "value": "[variables('subnetName')]"
                    },
                    "virtualNetworkName": {
                        "value": "[variables('virtualNetworkName')]"
                    },
                    "ipPrefix": {
                        "value": "[variables('jumpBoxIpPrefix')]"
                    },
                    "networkSecurityGroupName": {
                        "value": "[variables('networkSecurityGroupName')]"
                    },
                    "loadBalancerName": {
                        "value": "[variables('loadBalancerName')]"
                    },
                    "baseURI": {
                        "value": "[variables('baseURI')]"
                    }
                }
            }
        }
    ],
    "outputs": {}
}
