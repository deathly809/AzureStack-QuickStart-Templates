{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "apiProfile": "2017-03-09-profile",
    "parameters": {
        "clusterName": {
            "type": "string",
            "metadata": {
                "description": "Name of the Hadoop cluster.  This must be a globally unique name."
            }
        },
        "adminUsername": {
            "type": "string",
            "metadata": {
                "description": "Cluster administrator account name."
            }
        },
        "adminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Cluster administrator account password."
            }
        },
        "storageAccountType": {
            "type": "string",
            "defaultValue": "Standard_LRS",
            "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS"
            ],
            "metadata": {
                "description": "Storage account type for your hadoop cluster."
            }
        },
        "masterNodeVMSize": {
            "type": "string",
            "defaultValue": "Standard_D3_v2",
            "allowedValues": [
                "Standard_D3_v2",
                "Standard_D4_v2",
                "Standard_D5_v2",
                "Standard_DS3_v2",
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_F8",
                "Standard_F16",
                "Standard_F8s",
                "Standard_F16s",
                "Standard_F8s_v2",
                "Standard_F16s_v2",
                "Standard_D12",
                "Standard_D13",
                "Standard_D12_v2",
                "Standard_D13_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2"
            ],
            "metadata": {
                "description": "The size of the virtual machine for master nodes."
            }
        },
        "workerNodeVMSize": {
            "type": "string",
            "defaultValue": "Standard_DS4_v2",
            "allowedValues": [
                "Standard_DS4_v2",
                "Standard_DS5_v2",
                "Standard_DS11_v2",
                "Standard_DS12_v2",
                "Standard_DS13_v2",
                "Standard_DS14_v2",
                "Standard_F8s_v2",
                "Standard_F8",
                "Standard_F16",
                "Standard_F16s",
                "Standard_F8s",
                "Standard_F16s_v2",
                "Standard_F32s_v2",
                "Standard_D12_v2",
                "Standard_D13_v2"
            ],
            "metadata": {
                "description": "The size of the Virtual Machine for worker nodes."
            }
        },
        "numberWorkerNodes": {
            "type": "int",
            "metadata": {
                "description": "Number of worker nodes in your system."
            }
        },
        "dataDiskSize": {
            "type": "int",
            "metadata": {
                "description": "Size of the data disks on the workers."
            }
        },
        "numberMappers": {
            "type": "int",
            "metadata": {
                "description": "Number of mappers for Terasort. This is also used to generate and validate."
            }
        },
        "numberReducers": {
            "type": "int",
            "metadata": {
                "description": "Number of reducers for Terasort. This is also used to generate and validate."
            }
        },
        "pollingInterval": {
            "type": "int",
            "defaultValue": 1,
            "metadata": {
                "description": "Interval in seconds to record performance data.  Current allowed values are due to current implementation issues."
            },
            "allowedValues": [
                1,
                2,
                3,
                4,
                5,
                6,
                10,
                12,
                15,
                20,
                30,
                60
            ]
        },
        "baseURI": {
            "type": "string",
            "defaultValue": "https://raw.githubusercontent.com/deathly809/AzureStack-QuickStart-Templates/hadoop/terasort",
            "metadata": {
                "description": "Base URI where scripts are located."
            }
        },
        "batchSize": {
            "type": "int",
            "defaultValue": 10,
            "minValue": 1,
            "maxValue": 40,
            "metadata": {
                "description": "How many resources to attempt to deploy at once."
            }
        },
        "timeout": {
            "type": "int",
            "metadata": {
                "description": "Timeout in minutes before we cancel Terasort."
            }
        }
    },
    "variables": {
        "defaultName": "[parameters('clusterName')]",
        "masters": [
            "NameNode",
            "ResourceManager",
            "JobHistory"
        ],
        "numberMasters": "[length(variables('masters'))]",
        "githubURI": "https://raw.githubusercontent.com/deathly809/AzureStack-QuickStart-Templates/hadoop/hadoop"
    },
    "resources": [
        {
            "apiVersion": "2016-02-01",
            "name": "linkedTemplate",
            "type": "Microsoft.Resources/deployments",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(variables('githubURI'),'/vm-linux-hadoop.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "clusterName": {
                        "value": "[parameters('clusterName')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "storageAccountType": {
                        "value": "[parameters('storageAccountType')]"
                    },
                    "masterNodeVMSize": {
                        "value": "[parameters('masterNodeVMSize')]"
                    },
                    "workerNodeVMSize": {
                        "value": "[parameters('workerNodeVMSize')]"
                    },
                    "numberWorkerNodes": {
                        "value": "[parameters('numberWorkerNodes')]"
                    },
                    "dataDiskSize": {
                        "value": "[parameters('dataDiskSize')]"
                    },
                    "batchSize": {
                        "value": "[parameters('batchSize')]"
                    }
                }
            }
        },
        {
            "name": "[concat(parameters('clusterName'),variables('masters')[copyIndex()],'/masterCustomScript')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "linkedTemplate"
            ],
            "copy": {
                "name": "masterTerasortPrepare",
                "count": "[variables('numberMasters')]"
            },
            "apiVersion": "2016-03-30",
            "tags": {
                "displayName": "Install certs on master."
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": "true",
                "settings": {
                    "timestamp": 2,
                    "fileUris": [
                        "[concat(parameters('baseURI'),'/scripts/prepareTerasort.sh')]"
                    ],
                    "commandToExecute": "[concat('bash prepareTerasort.sh',' ',parameters('adminUsername'),' ',parameters('adminPassword'),' ',parameters('pollingInterval'),' ',parameters('timeout'))]"
                }
            }
        },
        {
            "name": "[concat(variables('defaultName'),'Worker',copyIndex(),'/workerCustomScript')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "linkedTemplate"
            ],
            "copy": {
                "name": "workerTerasortPrepare",
                "count": "[parameters('numberWorkerNodes')]"
            },
            "apiVersion": "2016-03-30",
            "tags": {
                "displayName": "Sets up the worker to monitor performance."
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": "true",
                "settings": {
                    "timestamp": 2,
                    "fileUris": [
                        "[concat(parameters('baseURI'),'/scripts/prepareTerasort.sh')]"
                    ],
                    "commandToExecute": "[concat('bash prepareTerasort.sh',' ',parameters('adminUsername'),' ',parameters('adminPassword'),' ',parameters('pollingInterval'),' ',parameters('timeout'))]"
                }
            }
        },
        {
            "name": "[concat(variables('defaultName'),'Jumpbox/jumpboxCustomScript')]",
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "location": "[resourceGroup().location]",
            "dependsOn": [
                "masterTerasortPrepare",
                "workerTerasortPrepare"
            ],
            "apiVersion": "2016-03-30",
            "tags": {
                "displayName": "Executes Terasort from the Jumpbox."
            },
            "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.0",
                "autoUpgradeMinorVersion": "true",
                "settings": {
                    "timestamp": 2,
                    "fileUris": [
                        "[concat(parameters('baseURI'),'/scripts/runTerasort.sh')]",
                        "[concat(parameters('baseURI'),'/scripts/terasort.sh')]",
                        "[concat(parameters('baseURI'),'/config/sources.txt')]"
                    ],
                    "commandToExecute": "[concat('bash runTerasort.sh',' ',parameters('adminUsername'),' ',parameters('adminPassword'),' ',parameters('numberMappers'),' ',parameters('numberReducers'),' ',parameters('timeout'))]"
                }
            }
        }
    ],
    "outputs": {}
}
